{
  "id": null,
  "uid": "active-users",
  "title": "Active Users & Shops",
  "tags": ["provisioned"],
  "timezone": "browser",
  "schemaVersion": 36,
  "version": 1,
  "refresh": "30s",
  "time": {
    "from": "now-7d",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "days",
        "type": "interval",
        "label": "Last interval",
        "hide": 0,
        "query": "1h,6h,12h,1d,7d,30d,90d",
        "current": { "text": "7d", "value": "7d" }
      },
      {
        "name": "minAge",
        "type": "custom",
        "label": "Min Age",
        "hide": 0,
        "query": "0,18,25,35,50",
        "current": { "text": "0", "value": "0" }
      },
      {
        "name": "country",
        "type": "query",
        "label": "Country",
        "datasource": "ClickHouse",
        "query": "SELECT DISTINCT country FROM nearyou.users ORDER BY country",
        "includeAll": true,
        "allValue": ""
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "geomap",
      "title": "Users & Shops Map",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 12 },
      "options": {
        "lonField": "__lon__",
        "latField": "__lat__",
        "popupFields": ["_type", "user_id", "full_name", "shop_name", "category", "last_event"]
      },
      "targets": [
        {
          "refId": "A",
          "datasource": "ClickHouse",
          "format": "table",
          "rawSql": "\
SELECT toFloat64(longitude) AS __lon__, toFloat64(latitude) AS __lat__, 'user' AS _type,\
       user_id, full_name, age, country, max(event_time) OVER (PARTITION BY user_id) AS last_event\
FROM nearyou.user_events AS e \
ANY LEFT JOIN nearyou.users AS u USING user_id \
WHERE event_time >= now() - toInterval${days}()\
  AND age >= ${minAge}\
  {{ if not (eq .Var.country \"__all\") }}AND country = '${country}'{{ end }}\
"
        },
        {
          "refId": "B",
          "datasource": "Postgres",
          "format": "table",
          "rawSql": "\
SELECT ST_X(geom) AS __lon__, ST_Y(geom) AS __lat__, 'shop' AS _type,\
       shop_id AS user_id, shop_name AS full_name, NULL AS age, category AS country, NULL AS last_event\
FROM shops\
"
        }
      ]
    },
    {
      "id": 2,
      "type": "table",
      "title": "Active Users List",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "datasource": "ClickHouse",
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawSql": "\
SELECT user_id, full_name, email, country, age, max(event_time) AS last_event\
FROM nearyou.user_events AS e \
ANY LEFT JOIN nearyou.users AS u USING user_id \
WHERE event_time >= now() - toInterval${days}()\
  AND age >= ${minAge}\
  {{ if not (eq .Var.country \"__all\") }}AND country = '${country}'{{ end }}\
GROUP BY user_id, full_name, email, country, age\
ORDER BY last_event DESC\
LIMIT 500\
"
        }
      ]
    },
    {
      "id": 3,
      "type": "table",
      "title": "All Shops",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "datasource": "Postgres",
      "targets": [
        {
          "refId": "B",
          "format": "table",
          "rawSql": "SELECT shop_id, shop_name, address, category FROM shops ORDER BY shop_name LIMIT 500"
        }
      ]
    }
  ]
}
