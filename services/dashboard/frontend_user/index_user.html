<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>NearYou – User Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 24px;
      width: 320px;
      text-align: center;
      z-index: 1001;
    }
    .hidden { display: none; }
    input, button {
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #map {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      display: none;
    }
    /* header flessibile in alto */
    #header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    #welcomeText {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    #logoutButton {
      width: auto;
      padding: 8px 16px;
      background: #dc3545;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
    }
    #logoutButton:hover {
      background: #b02a37;
    }
  </style>
</head>
<body>

  <div id="login-card" class="card">
    <h2>Accedi a NearYou</h2>
    <input id="user"    placeholder="Username" autocomplete="username"/>
    <input id="pass"    type="password" placeholder="Password" autocomplete="current-password"/>
    <button id="btn">Accedi</button>
    <div id="err" style="color:red; margin-top:8px;"></div>
  </div>

  <!-- Header con welcome e logout -->
  <div id="header" class="hidden">
    <div id="welcomeText"></div>
    <button id="logoutButton">Esci</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let token = "";
    let username = "";

    // per tracciare il percorso
    let latlngs = [];
    let polyline = null;
    let marker = null, popup = null, bikeIcon = null;

    document.getElementById('btn').onclick = async () => {
      username = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value;
      document.getElementById('err').textContent = "";

      if (!username || !p) {
        document.getElementById('err').textContent = "Inserisci username e password.";
        return;
      }

      try {
        const res = await fetch('/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ username, password: p })
        });
        const j = await res.json();
        if (!res.ok) throw new Error(j.detail || 'Errore login');
        token = j.access_token;

        // Nascondi form e mostra mappa + header
        document.getElementById('login-card').classList.add('hidden');
        document.getElementById('map').style.display = 'block';
        document.getElementById('header').classList.remove('hidden');

        // Imposta il testo di benvenuto
        document.getElementById('welcomeText').textContent = `Benvenuto, ${username}!`;

        initMap();
      } catch(e) {
        document.getElementById('err').textContent = e.message;
      }
    };

    document.getElementById('logoutButton').onclick = () => {
      token = "";
      document.getElementById('pass').value = "";
      document.getElementById('login-card').classList.remove('hidden');
      document.getElementById('map').style.display = 'none';
      document.getElementById('header').classList.add('hidden');

      // reset percorso
      latlngs = [];
      if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
      }
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }
    };

    function initMap() {
      // inizializza mappa senza zoomControl
      map = L.map('map', { zoomControl: false }).setView([45.4642,9.19], 14);

      // tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // pulsanti zoom in basso a sinistra
      L.control.zoom({ position: 'bottomleft' }).addTo(map);

      bikeIcon = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/kml/shapes/cycling.png',
        iconSize: [32,32], iconAnchor: [16,32]
      });
      popup = L.popup();

      // prima chiamata e poi ripeti ogni 2s
      fetchPosition();
      setInterval(fetchPosition, 2000);
    }

    async function fetchPosition() {
      if (!token) return;
      const res = await fetch('/api/user/positions', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const { positions } = await res.json();
      if (!positions.length) return;

      const u = positions[0];
      const latlng = [u.latitude, u.longitude];

      // aggiorna marker
      if (!marker) {
        marker = L.marker(latlng, { icon: bikeIcon }).addTo(map);
        map.setView(latlng, 15);
      } else {
        marker.setLatLng(latlng);
      }

      // estendi la lista e (ri)disegna la polyline
      latlngs.push(latlng);
      if (polyline) {
        map.removeLayer(polyline);
      }
      polyline = L.polyline(latlngs).addTo(map);

      // popup per promo
      if (u.message) {
        popup
          .setLatLng(latlng)
          .setContent(`<strong>Promo:</strong> ${u.message}`)
          .openOn(map);
      }
    }
  </script>
</body>
</html>
