<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>NearYou – User Dashboard</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      position: absolute;
      top: 0; right: 0; bottom: 0; left: 0;
      display: none;
      z-index: 0;
    }
    #login-card {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 24px;
      text-align: center;
      z-index: 1001;
    }
    #login-card input,
    #login-card button {
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #login-card button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    #login-card button:hover {
      background: #0056b3;
    }
    #err {
      color: red;
      margin-top: 8px;
    }
    #header {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 48px;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    #welcomeText {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    #logoutButton {
      padding: 8px 16px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #logoutButton:hover {
      background: #b02a37;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="header">
    <div id="welcomeText"></div>
    <button id="logoutButton">Esci</button>
  </div>

  <div id="login-card">
    <h2>Accedi a NearYou</h2>
    <input id="user" placeholder="Username" autocomplete="username" />
    <input
      id="pass"
      type="password"
      placeholder="Password"
      autocomplete="current-password"
    />
    <button id="btn">Accedi</button>
    <div id="err"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let token = "",
      username = "";
    let map, marker, popup, bikeIcon, polyline;
    const latlngs = [];

    document.getElementById("btn").onclick = async () => {
      username = document.getElementById("user").value.trim();
      const pwd = document.getElementById("pass").value;
      document.getElementById("err").textContent = "";

      if (!username || !pwd) {
        document.getElementById("err").textContent = "Compila entrambi i campi.";
        return;
      }

      try {
        const res = await fetch("/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ username, password: pwd }),
        });
        const j = await res.json();
        if (!res.ok) throw new Error(j.detail || "Errore login");
        token = j.access_token;

        // mostra mappa e header
        document.getElementById("login-card").style.display = "none";
        document.getElementById("map").style.display = "block";
        document.getElementById("header").style.display = "flex";
        document.getElementById(
          "welcomeText"
        ).textContent = `Benvenuto, ${username}!`;

        initMap();
      } catch (e) {
        document.getElementById("err").textContent = e.message;
      }
    };

    document.getElementById("logoutButton").onclick = () => {
      token = "";
      document.getElementById("pass").value = "";
      document.getElementById("login-card").style.display = "block";
      document.getElementById("map").style.display = "none";
      document.getElementById("header").style.display = "none";
      // pulisci
      if (polyline) map.removeLayer(polyline);
      if (marker) map.removeLayer(marker);
      latlngs.length = 0;
    };

    function initMap() {
      map = L.map("map", { zoomControl: false }).setView(
        [45.4642, 9.19],
        14
      );
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);
      L.control.zoom({ position: "bottomleft" }).addTo(map);

      // forza il ricalcolo dimensioni
      setTimeout(() => {
        map.invalidateSize();
      }, 200);

      bikeIcon = L.icon({
        iconUrl:
          "https://maps.google.com/mapfiles/kml/shapes/cycling.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      });
      popup = L.popup();

      fetchPosition();
      setInterval(fetchPosition, 2000);
    }

    async function fetchPosition() {
      if (!token) return;
      try {
        const res = await fetch("/api/user/positions", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const { positions } = await res.json();
        console.log("Positions:", positions);
        if (!positions.length) return;

        const { latitude, longitude, message } = positions[0];
        const latlng = [latitude, longitude];

        if (!marker) {
          marker = L.marker(latlng, { icon: bikeIcon }).addTo(map);
          map.setView(latlng, 15);
        } else {
          marker.setLatLng(latlng);
        }

        latlngs.push(latlng);
        if (!polyline) {
          polyline = L.polyline(latlngs).addTo(map);
        } else {
          polyline.setLatLngs(latlngs);
        }

        if (message) {
          popup
            .setLatLng(latlng)
            .setContent(`<strong>Promo:</strong> ${message}`)
            .openOn(map);
        }
      } catch (err) {
        console.error("fetchPosition error:", err);
      }
    }
  </script>
</body>
</html>
