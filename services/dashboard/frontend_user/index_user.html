<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NearYou – Dashboard Utente</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2980b9;
      --accent-color: #e74c3c;
      --text-color: #333;
      --bg-color: #f8f9fa;
      --panel-bg: #fff;
      --panel-shadow: 0 2px 10px rgba(0,0,0,0.1);
      --border-color: #eaeaea;
      --success-color: #2ecc71;
    }

    .dark-theme {
      --primary-color: #2185d0;
      --secondary-color: #1a6fc0;
      --accent-color: #db2828;
      --text-color: #f0f0f0;
      --bg-color: #1e1e1e;
      --panel-bg: #2d2d2d;
      --panel-shadow: 0 2px 10px rgba(0,0,0,0.3);
      --border-color: #444;
      --success-color: #21ba45;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: background-color 0.3s ease;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* Header */
    #header {
      background: var(--panel-bg);
      color: var(--text-color);
      padding: 12px 20px;
      box-shadow: var(--panel-shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
    }

    .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 20px;
    }

    .logo i {
      color: var(--primary-color);
      margin-right: 8px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-color);
    }

    #user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    #user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    /* Main container */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 320px;
      background: var(--panel-bg);
      box-shadow: var(--panel-shadow);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar-section {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--panel-shadow);
    }

    .sidebar-section h3 {
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-section h3 i {
      color: var(--primary-color);
    }

    .user-info-list {
      list-style: none;
    }

    .user-info-list li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    .user-info-list li i {
      width: 24px;
      color: var(--primary-color);
      margin-right: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-item {
      padding: 10px;
      background: var(--bg-color);
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.8;
    }

    /* Notification list */
    .notification-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-item {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-radius: 6px;
      background: var(--bg-color);
      align-items: flex-start;
    }

    .notification-icon {
      background: var(--primary-color);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .notification-desc {
      font-size: 14px;
      opacity: 0.8;
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.6;
      margin-top: 4px;
    }

    /* Map container */
    #map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Map controls */
    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-controls button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--panel-bg);
      border: none;
      box-shadow: var(--panel-shadow);
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .map-controls button:hover {
      background-color: var(--primary-color);
      color: white;
    }

    #categories-filter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-bg);
      padding: 10px 15px;
      border-radius: 30px;
      box-shadow: var(--panel-shadow);
      display: flex;
      gap: 10px;
      overflow-x: auto;
      max-width: 80%;
      z-index: 1000;
    }

    .category-pill {
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      cursor: pointer;
      white-space: nowrap;
    }

    .category-pill.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* Login card */
    #login-card {
      position: absolute;
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: var(--panel-bg);
      border-radius: 8px;
      box-shadow: var(--panel-shadow);
      padding: 24px;
      text-align: center;
      z-index: 1001;
    }

    #login-card h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .input-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
    }

    #login-card input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--panel-bg);
      color: var(--text-color);
    }

    #login-card button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }

    #login-card button:hover {
      background: var(--secondary-color);
    }

    #err {
      color: var(--accent-color);
      margin-top: 12px;
      font-size: 14px;
    }

    /* Custom popup */
    .custom-popup {
      background: var(--panel-bg);
      border-radius: 8px;
      box-shadow: var(--panel-shadow);
      padding: 0;
      max-width: 300px;
      overflow: hidden;
    }

    .custom-popup .popup-header {
      background: var(--primary-color);
      color: white;
      padding: 10px 15px;
      font-weight: bold;
    }

    .custom-popup .popup-content {
      padding: 15px;
    }

    .custom-popup .popup-message {
      margin-top: 10px;
      padding: 10px;
      background: var(--bg-color);
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      #sidebar {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        transform: translateX(-100%);
      }

      #sidebar.active {
        transform: translateX(0);
      }

      .sidebar-toggle {
        display: block !important;
      }
    }

    .sidebar-toggle {
      display: none;
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: var(--panel-shadow);
      z-index: 1000;
      cursor: pointer;
      font-size: 18px;
    }

    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--panel-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--primary-color);
      border-left-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loader-text {
      font-size: 18px;
      color: var(--primary-color);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loader-text">Caricamento in corso...</div>
  </div>

  <div class="container" style="display: none;">
    <div id="header">
      <div class="logo">
        <i class="fas fa-location-dot"></i>
        <span>NearYou</span>
      </div>
      <div class="header-controls">
        <button id="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
        <div id="user-profile">
          <div id="user-avatar">U</div>
          <span id="welcomeText">Benvenuto</span>
          <button id="logoutButton" style="margin-left: 10px; padding: 5px 10px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            <i class="fas fa-sign-out-alt"></i> Esci
          </button>
        </div>
      </div>
    </div>

    <div class="main-container">
      <div id="sidebar">
        <div class="sidebar-section">
          <h3><i class="fas fa-user"></i> Profilo Utente</h3>
          <ul class="user-info-list" id="user-profile-info">
            <li><i class="fas fa-id-badge"></i> <span id="user-id">ID: --</span></li>
            <li><i class="fas fa-birthday-cake"></i> <span id="user-age">Età: --</span></li>
            <li><i class="fas fa-briefcase"></i> <span id="user-job">Professione: --</span></li>
            <li><i class="fas fa-heart"></i> <span id="user-interests">Interessi: --</span></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3><i class="fas fa-chart-line"></i> Statistiche</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="total-distance">0</div>
              <div class="stat-label">km percorsi</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="shops-nearby">0</div>
              <div class="stat-label">negozi vicini</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-notifications">0</div>
              <div class="stat-label">notifiche</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="active-time">0</div>
              <div class="stat-label">minuti attivi</div>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3><i class="fas fa-bell"></i> Promozioni Recenti</h3>
          <div class="notification-list" id="notifications-container">
            <!-- Notifications will be added here -->
          </div>
        </div>
      </div>

      <div id="map-container">
        <div id="map"></div>
        <div class="map-controls">
          <button id="center-map" title="Centra sulla mia posizione">
            <i class="fas fa-crosshairs"></i>
          </button>
          <button id="clear-route" title="Cancella percorso">
            <i class="fas fa-broom"></i>
          </button>
        </div>
        <div id="categories-filter">
          <div class="category-pill active" data-category="all">Tutti</div>
          <div class="category-pill" data-category="ristorante">Ristoranti</div>
          <div class="category-pill" data-category="abbigliamento">Abbigliamento</div>
          <div class="category-pill" data-category="supermercato">Supermercati</div>
          <div class="category-pill" data-category="elettronica">Elettronica</div>
          <div class="category-pill" data-category="bar">Bar & Caffè</div>
        </div>
        <button class="sidebar-toggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="login-card">
    <h2>Accedi a NearYou</h2>
    <div class="input-group">
      <label for="user">Username</label>
      <input id="user" placeholder="Inserisci username" autocomplete="username" />
    </div>
    <div class="input-group">
      <label for="pass">Password</label>
      <input id="pass" type="password" placeholder="Inserisci password" autocomplete="current-password" />
    </div>
    <button id="btn">Accedi</button>
    <div id="err"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Global state
    let token = "";
    let username = "";
    let map, userMarker, userPopup, userPolyline;
    let shopsMarkers = [];
    let allShops = [];
    let currentPosition = null;
    let routePoints = [];
    let notifications = [];
    let startTime = null;
    let categoryFilter = "all";
    let isDarkTheme = false;
    let userData = null;
    
    // User profile data
    const DEFAULT_USER_PROFILE = {
      id: null,
      age: "--",
      profession: "--",
      interests: "--"
    };
    
    // DOM Elements
    const loadingOverlay = document.getElementById("loading-overlay");
    const containerEl = document.querySelector(".container");
    const loginCard = document.getElementById("login-card");
    const sidebarEl = document.getElementById("sidebar");
    const welcomeText = document.getElementById("welcomeText");
    const userAvatar = document.getElementById("user-avatar");
    
    // Initialize
    document.addEventListener("DOMContentLoaded", function() {
      // UI event handlers
      document.getElementById("btn").onclick = handleLogin;
      document.getElementById("logoutButton").onclick = handleLogout;
      document.getElementById("theme-toggle").onclick = toggleTheme;
      document.getElementById("center-map").onclick = centerMapOnUser;
      document.getElementById("clear-route").onclick = clearRoute;
      document.querySelector(".sidebar-toggle").onclick = toggleSidebar;
      
      // Set up category filters
      const categoryPills = document.querySelectorAll(".category-pill");
      categoryPills.forEach(pill => {
        pill.addEventListener("click", () => {
          categoryPills.forEach(p => p.classList.remove("active"));
          pill.classList.add("active");
          categoryFilter = pill.dataset.category;
          filterShopsByCategory();
        });
      });
      
      // Check for stored theme preference
      const storedTheme = localStorage.getItem("nearYouTheme");
      if (storedTheme === "dark") {
        toggleTheme();
      }
      
      // Check for existing token
      const storedToken = sessionStorage.getItem("nearYouToken");
      if (storedToken) {
        token = storedToken;
        username = sessionStorage.getItem("nearYouUsername") || "";
        processLogin();
      } else {
        setTimeout(() => {
          loadingOverlay.style.display = "none";
        }, 500);
      }
    });
    
    function handleLogin() {
      const usernameInput = document.getElementById("user").value.trim();
      const pwd = document.getElementById("pass").value;
      document.getElementById("err").textContent = "";
      
      if (!usernameInput || !pwd) {
        document.getElementById("err").textContent = "Compila entrambi i campi.";
        return;
      }
      
      loadingOverlay.style.display = "flex";
      
      fetch("/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username: usernameInput, password: pwd }),
      })
      .then(res => res.json())
      .then(data => {
        if (!data.access_token) {
          throw new Error("Token non ricevuto");
        }
        token = data.access_token;
        username = usernameInput;
        
        // Store in session storage
        sessionStorage.setItem("nearYouToken", token);
        sessionStorage.setItem("nearYouUsername", username);
        
        processLogin();
      })
      .catch(err => {
        loadingOverlay.style.display = "none";
        document.getElementById("err").textContent = err.message || "Errore di login";
      });
    }
    
    function processLogin() {
      // Set welcome text and avatar
      welcomeText.textContent = `${username}`;
      userAvatar.textContent = username.charAt(0).toUpperCase();
      
      // Hide login, show container
      loginCard.style.display = "none";
      containerEl.style.display = "flex";
      
      // Initialize map and start update loop
      initMap();
      fetchUserProfile();
      fetchShops();
      
      // Set timer
      startTime = new Date();
      
      // Start position polling
      pollUserPosition();
      setInterval(pollUserPosition, 3000);
      
      // Update active time
      setInterval(updateActiveTime, 60000);
      
      // Hide loading overlay
      setTimeout(() => {
        loadingOverlay.style.display = "none";
      }, 500);
    }
    
    function handleLogout() {
      token = "";
      username = "";
      userData = { ...DEFAULT_USER_PROFILE };
      clearMap();
      notifications = [];
      
      // Clear storage
      sessionStorage.removeItem("nearYouToken");
      sessionStorage.removeItem("nearYouUsername");
      
      // Update UI
      containerEl.style.display = "none";
      loginCard.style.display = "block";
      document.getElementById("pass").value = "";
      
      // Reset stats
      document.getElementById("total-distance").textContent = "0";
      document.getElementById("shops-nearby").textContent = "0";
      document.getElementById("total-notifications").textContent = "0";
      document.getElementById("active-time").textContent = "0";
      
      // Reset profile
      document.getElementById("user-id").textContent = "ID: --";
      document.getElementById("user-age").textContent = "Età: --";
      document.getElementById("user-job").textContent = "Professione: --";
      document.getElementById("user-interests").textContent = "Interessi: --";
      
      // Clear notifications
      document.getElementById("notifications-container").innerHTML = "";
    }
    
    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      if (isDarkTheme) {
        document.body.classList.add("dark-theme");
        document.getElementById("theme-toggle").innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem("nearYouTheme", "dark");
      } else {
        document.body.classList.remove("dark-theme");
        document.getElementById("theme-toggle").innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem("nearYouTheme", "light");
      }
    }
    
    function toggleSidebar() {
      sidebarEl.classList.toggle("active");
    }
    
    function initMap() {
      map = L.map("map").setView([45.4642, 9.19], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);
      
      const userIcon = L.icon({
        iconUrl: "https://maps.google.com/mapfiles/kml/shapes/cycling.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      });
      
      userMarker = L.marker([45.4642, 9.19], { icon: userIcon });
      userPolyline = L.polyline([], { color: 'blue', weight: 3 });
      
      // Force map size calculation
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    }
    
    function clearMap() {
      if (map) {
        if (userMarker) map.removeLayer(userMarker);
        if (userPolyline) map.removeLayer(userPolyline);
        
        // Clear shop markers
        shopsMarkers.forEach(marker => map.removeLayer(marker));
        shopsMarkers = [];
        
        // Reset route
        routePoints = [];
      }
    }
    
    async function pollUserPosition() {
      if (!token) return;
      try {
        const res = await fetch("/api/user/positions", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const { positions } = await res.json();
        
        // Update UI only if we got positions
        if (positions && positions.length > 0) {
          updateUserPosition(positions[0]);
        }
      } catch (err) {
        console.error("Error fetching position:", err);
      }
    }
    
    function updateUserPosition(positionData) {
      const { latitude, longitude, message, user_id } = positionData;
      const latlng = [latitude, longitude];
      
      // Store position and update route
      currentPosition = latlng;
      routePoints.push(latlng);
      
      // Update map
      if (!userMarker._map) {
        userMarker.setLatLng(latlng).addTo(map);
        map.setView(latlng, 15);
      } else {
        userMarker.setLatLng(latlng);
      }
      
      // Update polyline
      userPolyline.setLatLngs(routePoints);
      if (!userPolyline._map) {
        userPolyline.addTo(map);
      }
      
      // Update notification if we have a message
      if (message && message.trim() !== "") {
        // Check if this is a new message
        const isNewMessage = !notifications.some(n => n.message === message);
        
        if (isNewMessage) {
          // Get the current timestamp
          const timestamp = new Date().toLocaleTimeString();
          
          // Determine the closest shop
          let closestShop = null;
          if (allShops.length > 0) {
            closestShop = findClosestShop(latlng);
          }
          
          // Create notification
          const notification = {
            id: Date.now(),
            message: message,
            timestamp: timestamp,
            shopName: closestShop ? closestShop.name : "Negozio nelle vicinanze",
            category: closestShop ? closestShop.category : "shopping"
          };
          
          // Add to notifications and update UI
          notifications.unshift(notification);
          updateNotifications();
          
          // Show popup on map
          if (userPopup) {
            map.closePopup(userPopup);
          }
          
          userPopup = L.popup({
            className: 'custom-popup'
          })
          .setLatLng(latlng)
          .setContent(`
            <div class="popup-header">${notification.shopName}</div>
            <div class="popup-content">
              <div>Sei vicino a questo negozio!</div>
              <div class="popup-message">${message}</div>
            </div>
          `)
          .openOn(map);
          
          // Update notification count
          document.getElementById("total-notifications").textContent = notifications.length;
        }
      }
      
      // Update total distance
      if (routePoints.length > 1) {
        const totalDistance = calculateRouteDistance(routePoints);
        document.getElementById("total-distance").textContent = totalDistance.toFixed(1);
      }
    }
    
    function updateNotifications() {
      const container = document.getElementById("notifications-container");
      container.innerHTML = "";
      
      // Show only the last 10 notifications
      const recentNotifications = notifications.slice(0, 10);
      
      if (recentNotifications.length === 0) {
        container.innerHTML = '<div class="notification-item">Nessuna notifica ricevuta</div>';
        return;
      }
      
      recentNotifications.forEach(notification => {
        // Choose icon based on category
        let iconClass = "fas fa-shopping-bag";
        if (notification.category === "ristorante" || notification.category === "bar") {
          iconClass = "fas fa-utensils";
        } else if (notification.category === "abbigliamento") {
          iconClass = "fas fa-tshirt";
        } else if (notification.category === "supermercato") {
          iconClass = "fas fa-shopping-cart";
        } else if (notification.category === "elettronica") {
          iconClass = "fas fa-laptop";
        }
        
        const notificationEl = document.createElement("div");
        notificationEl.className = "notification-item";
        notificationEl.innerHTML = `
          <div class="notification-icon">
            <i class="${iconClass}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">${notification.shopName}</div>
            <div class="notification-desc">${notification.message}</div>
            <div class="notification-time">${notification.timestamp}</div>
          </div>
        `;
        container.appendChild(notificationEl);
      });
    }
    
    async function fetchUserProfile() {
      if (!token) return;
      
      try {
        // Fetch profile data from the API
        const res = await fetch("/api/user/profile", {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        let profileData;
        
        try {
          profileData = await res.json();
        } catch (e) {
          console.error("Error parsing profile data:", e);
          // Fallback profile data
          profileData = {
            user_id: 1,
            age: Math.floor(Math.random() * 30) + 20,
            profession: ["Ingegnere", "Avvocato", "Medico", "Insegnante", "Studente"][Math.floor(Math.random() * 5)],
            interests: ["Tecnologia, Sport, Cinema", "Viaggi, Cibo, Libri", "Musica, Arte, Fotografia"][Math.floor(Math.random() * 3)]
          };
        }
        
        userData = {
          id: profileData.user_id,
          age: profileData.age,
          profession: profileData.profession,
          interests: profileData.interests
        };
        
        // Update UI
        document.getElementById("user-id").textContent = `ID: ${userData.id}`;
        document.getElementById("user-age").textContent = `Età: ${userData.age}`;
        document.getElementById("user-job").textContent = `Professione: ${userData.profession}`;
        document.getElementById("user-interests").textContent = `Interessi: ${userData.interests}`;
        
      } catch (err) {
        console.error("Error fetching user profile:", err);
      }
    }
    
    async function fetchShops() {
      if (!token) return;
      
      try {
        // Try to fetch shops from the API
        const res = await fetch("/api/shops/nearby?radius=1.0", {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        // If API call successful, use the data
        let shops;
        try {
          shops = await res.json();
        } catch (e) {
          // Fallback shop data
          shops = [
            { id: 1, shop_name: "Zara Milano", category: "abbigliamento", lat: 45.4646, lon: 9.1927 },
            { id: 2, shop_name: "Esselunga", category: "supermercato", lat: 45.4689, lon: 9.1824 },
            { id: 3, shop_name: "MediaWorld", category: "elettronica", lat: 45.4702, lon: 9.1901 },
            { id: 4, shop_name: "Starbucks", category: "bar", lat: 45.4649, lon: 9.1913 },
            { id: 5, shop_name: "Apple Store", category: "elettronica", lat: 45.4657, lon: 9.1898 },
            { id: 6, shop_name: "Pizzeria Da Michele", category: "ristorante", lat: 45.4632, lon: 9.1955 },
            { id: 7, shop_name: "H&M", category: "abbigliamento", lat: 45.4661, lon: 9.1904 },
            { id: 8, shop_name: "Carrefour Express", category: "supermercato", lat: 45.4672, lon: 9.1872 },
            { id: 9, shop_name: "Trattoria Milanese", category: "ristorante", lat: 45.4623, lon: 9.1885 },
            { id: 10, shop_name: "Bar Magenta", category: "bar", lat: 45.4630, lon: 9.1837 }
          ];
        }
        
        // Normalize shop data format (from API or fallback)
        allShops = shops.map(shop => ({
          id: shop.id || shop.shop_id,
          name: shop.shop_name || shop.name,
          category: shop.category,
          lat: shop.lat || (shop.geom ? shop.geom.coordinates[1] : 0),
          lon: shop.lon || (shop.geom ? shop.geom.coordinates[0] : 0)
        }));
        
        addShopsToMap(allShops);
        
        // Update shop count
        document.getElementById("shops-nearby").textContent = allShops.length;
        
      } catch (err) {
        console.error("Error fetching shops:", err);
      }
    }
    
    function addShopsToMap(shops) {
      // Clear existing markers
      shopsMarkers.forEach(marker => map.removeLayer(marker));
      shopsMarkers = [];
      
      shops.forEach(shop => {
        // Choose icon based on category
        let iconUrl = "https://maps.google.com/mapfiles/ms/icons/red.png";
        if (shop.category === "ristorante" || shop.category === "bar") {
          iconUrl = "https://maps.google.com/mapfiles/ms/icons/yellow.png";
        } else if (shop.category === "supermercato") {
          iconUrl = "https://maps.google.com/mapfiles/ms/icons/green.png";
        } else if (shop.category === "elettronica") {
          iconUrl = "https://maps.google.com/mapfiles/ms/icons/blue.png";
        }
        
        const shopIcon = L.icon({
          iconUrl: iconUrl,
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });
        
        const marker = L.marker([shop.lat, shop.lon], { icon: shopIcon })
          .bindPopup(`
            <div class="custom-popup">
              <div class="popup-header">${shop.name}</div>
              <div class="popup-content">
                <div>Categoria: ${shop.category}</div>
                <div>ID: ${shop.id}</div>
              </div>
            </div>
          `);
        
        marker.addTo(map);
        shopsMarkers.push(marker);
      });
    }
    
    function filterShopsByCategory() {
      // Filter shops by selected category
      let filteredShops = [...allShops];
      
      if (categoryFilter !== "all") {
        filteredShops = allShops.filter(shop => shop.category === categoryFilter);
      }
      
      // Update map
      addShopsToMap(filteredShops);
      
      // Update count
      document.getElementById("shops-nearby").textContent = filteredShops.length;
    }
    
    function findClosestShop(position) {
      if (!allShops || allShops.length === 0) return null;
      
      // Find closest shop based on distance
      let closestShop = null;
      let minDistance = Infinity;
      
      allShops.forEach(shop => {
        const distance = calculateHaversineDistance(
          position[0], position[1], 
          shop.lat, shop.lon
        );
        
        if (distance < minDistance) {
          minDistance = distance;
          closestShop = shop;
        }
      });
      
      return closestShop;
    }
    
    function centerMapOnUser() {
      if (currentPosition) {
        map.setView(currentPosition, 15);
      }
    }
    
    function clearRoute() {
      routePoints = [];
      if (currentPosition) {
        routePoints.push(currentPosition);
      }
      userPolyline.setLatLngs(routePoints);
      document.getElementById("total-distance").textContent = "0";
    }
    
    function updateActiveTime() {
      if (!startTime) return;
      
      const now = new Date();
      const diffMinutes = Math.floor((now - startTime) / 60000);
      document.getElementById("active-time").textContent = diffMinutes;
    }
    
    // Utility Functions
    function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c;
      return d;
    }
    
    function toRad(deg) {
      return deg * Math.PI / 180;
    }
    
    function calculateRouteDistance(points) {
      let distance = 0;
      for (let i = 1; i < points.length; i++) {
        distance += calculateHaversineDistance(
          points[i-1][0], points[i-1][1],
          points[i][0], points[i][1]
        );
      }
      return distance;
    }
  </script>
</body>
</html>