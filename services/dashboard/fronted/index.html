<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NearYou Live Dashboard</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #info {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding: 8px 12px; border-radius: 4px; font-family: sans-serif;
      z-index: 5;
    }
  </style>
  <!-- Inserisci qui la tua Google Maps JS API Key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
</head>
<body>
  <div id="info">Caricamento posizioni...</div>
  <div id="map"></div>
  <script>
    let map, marker, infowindow;
    const iconBike = {
      url: "http://maps.google.com/mapfiles/kml/shapes/cycling.png",
      scaledSize: new google.maps.Size(32, 32)
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: 45.4642, lng: 9.19 }
      });
      marker = new google.maps.Marker({ map, icon: iconBike });
      infowindow = new google.maps.InfoWindow();
      fetchAndUpdate();
      setInterval(fetchAndUpdate, 2000);
    }

    async function fetchAndUpdate() {
      try {
        const res  = await fetch("/api/positions");
        const data = await res.json();
        document.getElementById("info").textContent =
          `Utenti attivi: ${data.positions.length}`;
        if (data.positions.length) {
          const u   = data.positions[0];
          const pos = new google.maps.LatLng(u.latitude, u.longitude);
          marker.setPosition(pos);
          map.panTo(pos);
          if (u.message) {
            infowindow.setContent(`<strong>Promo:</strong> ${u.message}`);
            infowindow.open(map, marker);
          } else {
            infowindow.close();
          }
        }
      } catch (e) {
        console.error("Errore recupero posizioni:", e);
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
